<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–û–ø—Ä–æ—Å–Ω–∏–∫ —Å Gun.js ‚Äî –û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä / –£—á–∞—Å—Ç–Ω–∏–∫ / –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</title>

<!-- Gun.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>

<style>
  :root{
    --bg:#0f1724;
    --card:#0b1220;
    --accent:#7c5cff;
    --muted:#9aa4b2;
    --glass: rgba(255,255,255,0.03);
    --success:#22c55e;
    --danger:#ff6b6b;
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:linear-gradient(180deg,#071028 0%, #071827 60%);
    color:#e6eef8;
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:28px;
  }
  .app{
    width:100%;
    max-width:1100px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:14px;
    box-shadow: 0 10px 30px rgba(2,6,23,0.6);
    overflow:hidden;
    display:grid;
    grid-template-columns: 320px 1fr;
    gap:0;
  }
  .sidebar{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    padding:20px;
    border-right:1px solid rgba(255,255,255,0.03);
  }
  .logo{
    font-weight:700;
    font-size:18px;
    color:var(--accent);
    display:flex;
    gap:10px;
    align-items:center;
    margin-bottom:16px;
  }
  .tabs{display:flex;flex-direction:column;gap:10px}
  .tab{
    padding:12px;
    border-radius:8px;
    cursor:pointer;
    color:var(--muted);
    display:flex;
    gap:10px;
    align-items:center;
  }
  .tab.active{ background:linear-gradient(90deg, rgba(124,92,255,0.14), rgba(124,92,255,0.06)); color:#fff; box-shadow: inset 0 0 14px rgba(124,92,255,0.04); }
  .main{
    padding:24px;
    min-height:560px;
  }
  .card{
    background:var(--card);
    padding:18px;
    border-radius:12px;
    margin-bottom:16px;
    border:1px solid rgba(255,255,255,0.02);
  }
  label{display:block;font-size:13px;color:var(--muted); margin-bottom:8px}
  input[type="text"], input[type="number"], textarea, select{
    width:100%;
    padding:10px 12px;
    border-radius:8px;
    border:1px solid rgba(255,255,255,0.04);
    background:var(--glass);
    color:inherit;
    outline:none;
    margin-bottom:12px;
    font-size:14px;
  }
  textarea{min-height:80px; resize:vertical}
  .row{display:flex; gap:12px}
  .row .card{flex:1}
  button{
    padding:10px 14px;
    border-radius:10px;
    border:0;
    cursor:pointer;
    font-weight:600;
    background:linear-gradient(90deg,var(--accent), #6bb2ff);
    color:#061425;
    box-shadow: 0 6px 18px rgba(124,92,255,0.12);
  }
  .ghost{
    background:transparent;
    border:1px solid rgba(255,255,255,0.06);
    color:var(--muted);
    box-shadow:none;
  }
  .small{padding:6px 8px; font-size:13px; border-radius:8px}
  .codes{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .code-pill{background:rgba(255,255,255,0.03); padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02); font-weight:600;}
  .option-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
  .option-row input[type="text"]{flex:1}
  .flex-between{display:flex;align-items:center;justify-content:space-between}
  .muted{color:var(--muted); font-size:13px}
  .bar{
    height:18px;border-radius:8px;background:rgba(255,255,255,0.04);overflow:hidden;display:block;
  }
  .bar > i{display:block;height:100%; background:linear-gradient(90deg,var(--accent), #6bb2ff); border-radius:8px;}
  .center{display:flex;align-items:center;justify-content:center}
  .danger{background:linear-gradient(90deg,var(--danger), #ff9c9c); color:#0b1016}
  .success{background:linear-gradient(90deg,var(--success), #7ef39a); color:#062014}
  footer{font-size:13px;color:var(--muted); margin-top:8px}
  @media (max-width:880px){
    .app{grid-template-columns:1fr; padding:12px}
    .sidebar{order:2}
  }
</style>
</head>
<body>
<div class="app" role="application" aria-label="–û–ø—Ä–æ—Å–Ω–∏–∫ —Å Gun.js">
  <aside class="sidebar">
    <div class="logo">üîÆ <span>–û–ø—Ä–æ—Å–Ω–∏–∫ (Gun.js)</span></div>
    <div class="tabs" role="tablist" aria-label="tabs">
      <div class="tab active" data-tab="organizer" role="tab">–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä</div>
      <div class="tab" data-tab="voter" role="tab">–£—á–∞—Å—Ç–Ω–∏–∫</div>
      <div class="tab" data-tab="results" role="tab">–ò—Ç–æ–≥–∏</div>
    </div>

    <div style="margin-top:18px" class="muted">
      –õ–æ–∫–∞–ª—å–Ω–∞—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–µ peer'—ã Gun –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.<br>
      –î–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω–∞ ‚Äî –¥–æ–±–∞–≤—å—Ç–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π peer.
    </div>
    <footer>–í–µ—Ä—Å–∏—è demo ‚Ä¢ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: –ø—É–±–ª–∏—á–Ω—ã–µ peer'—ã</footer>
  </aside>

  <main class="main">
    <!-- ORGANIZER -->
    <section id="organizerView" class="card" aria-hidden="false">
      <h2>–°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å</h2>
      <div style="margin-top:6px" class="muted">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å¬ª ‚Äî –∫–∞–∂–¥–æ–º—É —É—á–∞—Å—Ç–Ω–∏–∫—É –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞.</div>

      <label>–í–æ–ø—Ä–æ—Å</label>
      <input id="q_question" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö—É–¥–∞ –ø–æ–µ—Ö–∞—Ç—å –≤ –æ—Ç–ø—É—Å–∫?" />

      <label>–í–∞—Ä–∏–∞–Ω—Ç—ã (–æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç –Ω–∞ —Å—Ç—Ä–æ–∫—É)</label>
      <textarea id="q_options" placeholder="–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ –ø–æ –ï–≤—Ä–æ–ø–µ\n–ú–∞–π–∞–º–∏\n–û—Ç–¥—ã—Ö –≤ –≥–æ—Ä–∞—Ö"></textarea>

      <label>–£—á–∞—Å—Ç–Ω–∏–∫–∏ (–æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å –Ω–∞ —Å—Ç—Ä–æ–∫—É ‚Äî –∏–º—è)</label>
      <textarea id="q_participants" placeholder="–ê–Ω—è\n–ë–æ—Ä–∏—Å\n–í–∏–∫—Ç–æ—Ä"></textarea>

      <label>–ì–æ–ª–æ—Å–∞ –Ω–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞ (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)</label>
      <input id="q_votesPer" type="number" min="1" value="3" />

      <div style="display:flex;gap:12px;margin-top:8px;align-items:center">
        <button id="createPollBtn">–°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å</button>
        <button id="loadFromUrlBtn" class="ghost">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ —Å—Å—ã–ª–∫–µ</button>
        <button id="clearBtn" class="ghost small">–°–±—Ä–æ—Å–∏—Ç—å</button>
      </div>

      <div id="createdInfo" style="margin-top:12px;display:none" class="card">
        <div class="flex-between">
          <div>
            <div style="font-weight:700" id="createdPollId"></div>
            <div class="muted">–°—Å—ã–ª–∫–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞: <span id="createdLink"></span></div>
          </div>
          <div>
            <button id="copyLink" class="small">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="muted">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–¥—ã –¥–æ—Å—Ç—É–ø–∞ (–¥–∞–π—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º):</div>
          <div id="codesList" class="codes"></div>
        </div>
      </div>
    </section>

    <!-- VOTER -->
    <section id="voterView" class="card" aria-hidden="true" style="display:none">
      <h2>–£—á–∞—Å—Ç–Ω–∏–∫ ‚Äî –≤–æ–π—Ç–∏ –ø–æ –∫–æ–¥—É</h2>
      <div class="muted">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏—Å–ª–∞–ª –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä.</div>

      <label>–ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞</label>
      <input id="v_code" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: A1B2C3" />
      <div style="display:flex;gap:10px">
        <button id="enterCodeBtn">–í–æ–π—Ç–∏</button>
        <button id="enterLinkBtn" class="ghost">–í–æ–π—Ç–∏ –ø–æ —Å—Å—ã–ª–∫–µ</button>
      </div>

      <div id="voterPanel" style="margin-top:12px;display:none">
        <div class="card">
          <div class="flex-between">
            <div>
              <div id="voterName" style="font-weight:700"></div>
              <div class="muted" id="voterVotesLeft"></div>
            </div>
            <div>
              <button id="logoutBtn" class="ghost small">–í—ã–π—Ç–∏</button>
            </div>
          </div>

          <div style="margin-top:12px" id="voterQuestionArea"></div>
        </div>
      </div>
    </section>

    <!-- RESULTS -->
    <section id="resultsView" class="card" style="display:none" aria-hidden="true">
      <h2>–û–±—â–∏–µ –∏—Ç–æ–≥–∏</h2>
      <div class="muted">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–≥—Ä–µ–≥–∏—Ä—É—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ —Å–æ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤.</div>

      <div style="margin-top:12px" id="resultsArea"></div>
      <div style="margin-top:10px" class="flex-between">
        <div class="muted" id="lastSync">‚Äî</div>
        <div>
          <button id="refreshBtn" class="ghost small">–û–±–Ω–æ–≤–∏—Ç—å</button>
          <button id="resetVotes" class="danger small">–°–±—Ä–æ—Å–∏—Ç—å –≥–æ–ª–æ—Å–∞ (–æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä)</button>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
/*
  –û–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö –≤ Gun:
  gun.get('polls').get(pollId).put({
    question: '...',
    options: { optId1: {id:'optId1', text:'...', }, optId2: ... },
    participants: { code1: { name:'–ê–Ω—è', assigned:3, votesGiven: {optId1:2, optId2:1} }, ... },
    createdAt: timestamp
  })
*/

// ====== Utils ======
const randCode = (len=6) => {
  const alph = 'ABCDEFGHJKMNPQRSTUVWXYZ23456789';
  let s='';
  for(let i=0;i<len;i++) s += alph.charAt(Math.floor(Math.random()*alph.length));
  return s;
}
const uid = (n=8) => Math.random().toString(36).slice(2,2+n);
const el = id => document.getElementById(id);

// ====== Gun init ======
const gun = Gun({
  peers: [
    'https://gun-manhattan.herokuapp.com/gun',
    'https://gunjs.herokuapp.com/gun'
  ]
});
// main polls collection
const polls = gun.get('polls');

// UI state
let currentPollId = null;
let currentParticipantCode = null;
let currentParticipantName = null;

// Tabs
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const tab = t.dataset.tab;
    showTab(tab);
  });
});
function showTab(name){
  el('organizerView').style.display = name==='organizer' ? 'block':'none';
  el('voterView').style.display = name==='voter' ? 'block':'none';
  el('resultsView').style.display = name==='results' ? 'block':'none';
}

// ====== Organizer: create poll ======
el('createPollBtn').addEventListener('click', async ()=>{
  const question = el('q_question').value.trim();
  const optionsText = el('q_options').value.trim();
  const participantsText = el('q_participants').value.trim();
  const votesPer = parseInt(el('q_votesPer').value, 10) || 1;

  if(!question || !optionsText || !participantsText){
    alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤–æ–ø—Ä–æ—Å, –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.');
    return;
  }

  // prepare structures
  const optionsArr = optionsText.split('\n').map(s=>s.trim()).filter(Boolean);
  const participantsArr = participantsText.split('\n').map(s=>s.trim()).filter(Boolean);

  // create IDs
  const pollId = uid(10);
  const options = {};
  optionsArr.forEach((t,i)=>{
    const id = 'o'+(i+1)+'_'+uid(4);
    options[id] = { id, text: t };
  });

  // participants -> generate codes
  const participants = {};
  const codes = [];
  participantsArr.forEach((name)=>{
    const code = randCode(6);
    const p = { name, assigned: votesPer, votesGiven: {} };
    participants[code] = p;
    codes.push({ code, name });
  });

  const pollObj = {
    id: pollId,
    question,
    options,
    participants,
    createdAt: Date.now()
  };

  // store to Gun
  polls.get(pollId).put(pollObj, ack=>{
    if(ack.err){
      console.error('gun put err', ack);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ–ø—Ä–æ—Å–∞. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∫–æ–Ω—Å–æ–ª—å.');
      return;
    }
    currentPollId = pollId;
    showCreatedInfo(pollId, codes);
    // update URL for sharing
    const link = window.location.origin + window.location.pathname + '?poll=' + pollId;
    el('createdLink').textContent = link;
  });
});

el('clearBtn').addEventListener('click', ()=>{
  if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª—è —Ñ–æ—Ä–º—ã?')) {
    el('q_question').value='';
    el('q_options').value='';
    el('q_participants').value='';
    el('q_votesPer').value='3';
    el('createdInfo').style.display='none';
  }
});

// load pollId from URL if present
function pollIdFromUrl(){
  const u = new URL(window.location.href);
  return u.searchParams.get('poll');
}
el('loadFromUrlBtn').addEventListener('click', ()=>{
  const p = pollIdFromUrl();
  if(p){
    loadPollToOrganizer(p);
  } else {
    alert('–í URL –Ω–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ poll. –ü—Ä–∏–º–µ—Ä: ?poll=abcd123');
  }
});

el('copyLink').addEventListener('click', ()=>{
  const link = el('createdLink').textContent;
  if(link){
    navigator.clipboard?.writeText(link).then(()=>alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞'));
  }
});

function showCreatedInfo(pollId, codes){
  el('createdInfo').style.display = 'block';
  el('createdPollId').textContent = 'Poll ID: ' + pollId;
  el('createdLink').textContent = window.location.origin + window.location.pathname + '?poll=' + pollId;
  const codesList = el('codesList');
  codesList.innerHTML = '';
  codes.forEach(c=>{
    const pill = document.createElement('div');
    pill.className = 'code-pill';
    pill.textContent = `${c.name} ‚Äî ${c.code}`;
    codesList.appendChild(pill);
  });
  // subscribe to poll updates to reflect live
  subscribeToPoll(pollId);
}

// load poll for organizer to show existing codes
function loadPollToOrganizer(pollId){
  polls.get(pollId).once(data=>{
    if(!data){
      alert('–û–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.');
      return;
    }
    currentPollId = pollId;
    el('createdInfo').style.display='block';
    el('createdPollId').textContent = 'Poll ID: ' + pollId;
    el('createdLink').textContent = window.location.origin + window.location.pathname + '?poll=' + pollId;
    // show codes
    const codes = [];
    if(data.participants){
      Object.keys(data.participants).forEach(code=>{
        codes.push({ code, name: data.participants[code].name, assigned: data.participants[code].assigned});
      });
    }
    const codesList = el('codesList');
    codesList.innerHTML = '';
    codes.forEach(c=>{
      const pill = document.createElement('div');
      pill.className = 'code-pill';
      pill.textContent = `${c.name} ‚Äî ${c.code} (${c.assigned} –≥–æ–ª.)`;
      codesList.appendChild(pill);
    });
    subscribeToPoll(pollId);
  });
}

// ====== Subscribe to poll updates (used by organizer & results) ======
let pollSub = null;
function subscribeToPoll(pollId){
  if(pollSub && pollSub.off) pollSub.off();
  pollSub = polls.get(pollId).on((data, key)=>{
    // update results area and organizer codes if open
    renderResults(data);
    // update organizer codes list if organizer view active
    if(document.querySelector('.tab.active').dataset.tab === 'organizer'){
      if(data && data.participants){
        const codesList = el('codesList');
        const arr = Object.keys(data.participants).map(code=>({ code, ...data.participants[code] }));
        codesList.innerHTML = '';
        arr.forEach(p=>{
          const pill = document.createElement('div');
          pill.className = 'code-pill';
          pill.textContent = `${p.name} ‚Äî ${p.code || p.name} (${p.assigned} –≥–æ–ª.)`;
          codesList.appendChild(pill);
        });
      }
    }
    // update current voter UI if logged in
    if(currentParticipantCode && currentPollId === pollId){
      polls.get(pollId).once(d=>{
        populateVoterPanel(d, currentParticipantCode);
      });
    }
    el('lastSync').textContent = '–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: ' + new Date().toLocaleTimeString();
  });
}

// ====== Voter: enter code ======
el('enterCodeBtn').addEventListener('click', ()=>{
  const code = el('v_code').value.trim().toUpperCase();
  if(!code) { alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥.'); return; }
  const pid = pollIdFromUrl();
  if(!pid && !currentPollId){
    alert('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å Poll ID. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ–ø—Ä–æ—Å –≤ —Ä–∞–∑–¥–µ–ª–µ –û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É —Å ?poll=...');
    return;
  }
  const pollId = pid || currentPollId;
  attemptEnterAsParticipant(pollId, code);
});
el('enterLinkBtn').addEventListener('click', ()=>{
  const pid = pollIdFromUrl();
  if(!pid) { alert('–í URL –Ω–µ—Ç poll=...'); return; }
  const code = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞');
  if(code) attemptEnterAsParticipant(pid, code.trim().toUpperCase());
});
el('logoutBtn').addEventListener('click', ()=>{
  if(confirm('–í—ã–π—Ç–∏?')) {
    currentParticipantCode = null;
    currentParticipantName = null;
    el('voterPanel').style.display = 'none';
    el('v_code').value = '';
  }
});

function attemptEnterAsParticipant(pollId, code){
  polls.get(pollId).once(data=>{
    if(!data){
      alert('–û–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.');
      return;
    }
    const parts = data.participants || {};
    if(!parts[code]){
      alert('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–¥ —É –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞.');
      return;
    }
    // success
    currentPollId = pollId;
    currentParticipantCode = code;
    currentParticipantName = parts[code].name;
    // show panel
    el('voterPanel').style.display = 'block';
    el('voterName').textContent = parts[code].name;
    // subscribe
    subscribeToPoll(pollId);
    // show question & options
    populateVoterPanel(data, code);
  });
}

function populateVoterPanel(pollData, code){
  if(!pollData) return;
  const assigned = pollData.participants?.[code]?.assigned || 0;
  const votesGiven = pollData.participants?.[code]?.votesGiven || {};
  // compute used
  let used = 0;
  Object.values(votesGiven).forEach(v=> used += Number(v || 0));
  const left = Math.max(0, assigned - used);
  el('voterVotesLeft').textContent = `–í—Å–µ–≥–æ: ${assigned} ‚Ä¢ –ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–Ω–æ: ${used} ‚Ä¢ –û—Å—Ç–∞–ª–æ—Å—å: ${left}`;
  // render options with inputs
  const area = el('voterQuestionArea');
  area.innerHTML = '';
  const q = document.createElement('div');
  q.innerHTML = `<div style="font-weight:700">${pollData.question}</div><div class="muted" style="margin-top:6px">–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –≤–∞—à–∏ –≥–æ–ª–æ—Å–∞ –º–µ–∂–¥—É –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ (—Å—É–º–º–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –ø—Ä–µ–≤—ã—à–∞—Ç—å ${assigned}).</div>`;
  area.appendChild(q);

  const form = document.createElement('div');
  form.style.marginTop='12px';
  Object.keys(pollData.options||{}).forEach(optId=>{
    const opt = pollData.options[optId];
    const row = document.createElement('div');
    row.className = 'option-row';
    const label = document.createElement('div');
    label.style.flex='1';
    label.innerHTML = `<div style="font-weight:600">${opt.text}</div><div class="muted" style="font-size:13px">ID: ${optId}</div>`;
    const input = document.createElement('input');
    input.type='number';
    input.min='0';
    input.value = Number(votesGiven?.[optId] || 0);
    input.style.width='86px';
    input.dataset.opt = optId;
    row.appendChild(label);
    row.appendChild(input);
    form.appendChild(row);
  });
  // action buttons
  const btnWrap = document.createElement('div');
  btnWrap.style.display='flex';
  btnWrap.style.gap='8px';
  btnWrap.style.marginTop='12px';
  const submitBtn = document.createElement('button');
  submitBtn.textContent = '–ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å';
  const previewBtn = document.createElement('button');
  previewBtn.className='ghost';
  previewBtn.textContent='–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä';
  btnWrap.appendChild(submitBtn);
  btnWrap.appendChild(previewBtn);
  form.appendChild(btnWrap);
  area.appendChild(form);

  previewBtn.addEventListener('click', ()=>{
    const entries = Array.from(form.querySelectorAll('input[type=number]')).map(i=>({opt:i.dataset.opt, val: Number(i.value || 0)}));
    const sum = entries.reduce((s,e)=>s+e.val,0);
    alert('–°—É–º–º–∞ –≥–æ–ª–æ—Å–æ–≤: ' + sum + '. –û—Å—Ç–∞–ª–æ—Å—å: ' + (assigned - sum));
  });

  submitBtn.addEventListener('click', ()=>{
    // collect and validate
    const entries = Array.from(form.querySelectorAll('input[type=number]')).map(i=>({opt:i.dataset.opt, val: Math.max(0, Math.floor(Number(i.value || 0)))}));
    const sum = entries.reduce((s,e)=>s+e.val,0);
    if(sum > assigned){
      alert(`–ù–µ–ª—å–∑—è –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å –±–æ–ª—å—à–µ –≥–æ–ª–æ—Å–æ–≤, —á–µ–º –≤–∞–º –Ω–∞–∑–Ω–∞—á–µ–Ω–æ (${assigned}). –°–µ–π—á–∞—Å —É –≤–∞—Å ${sum}.`);
      return;
    }
    // write votesGiven for this participant
    const votesGivenObj = {};
    entries.forEach(e => { if(e.val>0) votesGivenObj[e.opt] = e.val; });
    // set participant.votesGiven in Gun
    const base = polls.get(currentPollId).get('participants').get(currentParticipantCode);
    base.put({ ... (pollData.participants?.[currentParticipantCode] || {}), votesGiven: votesGivenObj }, ack=>{
      if(ack.err) {
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤.');
        console.error(ack);
      } else {
        alert('–°–ø–∞—Å–∏–±–æ ‚Äî –≤–∞—à –≥–æ–ª–æ—Å —É—á—Ç—ë–Ω.');
        // update local UI display using latest data
        polls.get(currentPollId).once(d=> populateVoterPanel(d, currentParticipantCode));
        // switch to results tab maybe
      }
    });
  });
}

// ====== Results rendering ======
function renderResults(pollData){
  const area = el('resultsArea');
  if(!pollData){
    area.innerHTML = '<div class="muted">–û–ø—Ä–æ—Å –Ω–µ –≤—ã–±—Ä–∞–Ω –∏–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.</div>';
    return;
  }
  // show question
  let html = `<div style="font-weight:700">${pollData.question}</div><div class="muted" style="margin-top:6px">–°–æ–∑–¥–∞–Ω: ${new Date(pollData.createdAt || Date.now()).toLocaleString()}</div>`;
  // aggregate totals by options
  const totals = {};
  Object.keys(pollData.options || {}).forEach(oid => totals[oid]=0);
  const participants = pollData.participants || {};
  Object.keys(participants).forEach(code=>{
    const p = participants[code];
    if(p && p.votesGiven){
      Object.keys(p.votesGiven).forEach(oid=>{
        const v = Number(p.votesGiven[oid] || 0);
        if(!totals[oid]) totals[oid]=0;
        totals[oid]+=v;
      });
    }
  });

  // total sum
  const totalSum = Object.values(totals).reduce((s,v)=>s+v,0);

  html += '<div style="margin-top:12px">';
  Object.keys(pollData.options || {}).forEach(oid=>{
    const opt = pollData.options[oid];
    const val = totals[oid] || 0;
    const pct = totalSum ? Math.round(val/totalSum*100) : 0;
    html += `
      <div style="margin-bottom:10px">
        <div class="flex-between" style="gap:10px">
          <div style="font-weight:600">${opt.text}</div>
          <div class="muted">${val} –≥–æ–ª–æ—Å–æ–≤ ‚Ä¢ ${pct}%</div>
        </div>
        <div class="bar" aria-hidden="true"><i style="width:${pct}%;"></i></div>
      </div>
    `;
  });
  html += '</div>';

  // show participants & breakdown
  html += '<div style="margin-top:12px" class="card">';
  html += '<div style="font-weight:700;margin-bottom:6px">–£—á–∞—Å—Ç–Ω–∏–∫–∏ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</div>';
  html += '<div class="muted">–°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏ —Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏</div>';
  html += '<div style="margin-top:8px">';
  Object.keys(participants).forEach(code=>{
    const p = participants[code];
    const used = p.votesGiven ? Object.values(p.votesGiven).reduce((s,v)=>s+Number(v),0) : 0;
    html += `<div style="margin-bottom:8px"><strong>${p.name}</strong> ‚Äî –Ω–∞–∑–Ω–∞—á–µ–Ω–æ: ${p.assigned}, –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–Ω–æ: ${used} <span class="muted">[${code}]</span></div>`;
    if(p.votesGiven){
      html += '<div class="muted" style="margin-left:8px">';
      Object.keys(p.votesGiven).forEach(oid=>{
        const t = pollData.options?.[oid]?.text || oid;
        html += `${t}: ${p.votesGiven[oid]}; `;
      });
      html += '</div>';
    }
  });
  html += '</div></div>';

  area.innerHTML = html;
}

// manual refresh
el('refreshBtn').addEventListener('click', ()=>{
  if(!currentPollId) return alert('Poll ID –Ω–µ –≤—ã–±—Ä–∞–Ω.');
  polls.get(currentPollId).once(data=>{
    renderResults(data);
  });
});

// reset votes (organizer action)
el('resetVotes').addEventListener('click', ()=>{
  if(!currentPollId) return alert('Poll ID –Ω–µ –≤—ã–±—Ä–∞–Ω.');
  if(!confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –≥–æ–ª–æ—Å–∞ (—É–¥–∞–ª–∏—Ç—å votesGiven —É –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)?')) return;
  // fetch poll and remove votesGiven subfield
  polls.get(currentPollId).once(poll=>{
    if(!poll || !poll.participants) return alert('–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏–ª–∏ –æ–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.');
    // for each participant, set votesGiven to {}
    Object.keys(poll.participants).forEach(code=>{
      polls.get(currentPollId).get('participants').get(code).put({ ...poll.participants[code], votesGiven: {} });
    });
    alert('–ì–æ–ª–æ—Å–∞ —Å–±—Ä–æ—à–µ–Ω—ã.');
  });
});

// If URL contains poll=, try to load it (useful when opening link)
window.addEventListener('load', ()=>{
  const pid = pollIdFromUrl();
  if(pid){
    currentPollId = pid;
    // pre-load to organizer and results
    polls.get(pid).once(data=>{
      if(!data){
        // not found yet
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        document.querySelector('.tab[data-tab="voter"]').classList.add('active');
        showTab('voter');
        el('voterPanel').style.display='none';
        return;
      }
      // If we opened via link, show results tab by default
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelector('.tab[data-tab="voter"]').classList.add('active');
      showTab('voter');
      // keep subscriber for live updates
      subscribeToPoll(pid);
    });
  }
});

// Helper: when poll created, subscribe
// There's already subscribe in create flow

// Accessibility: show organizer loaded poll via "loadFromUrlBtn" if poll in URL
</script>
</body>
</html>
