<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Онлайн-опросник с монетами • GUN.js (P2P)</title>

  <!-- GUN: P2P-граф без ваших серверов -->
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/sea.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/lib/webrtc.js"></script>

  <!-- Chart.js подключим лениво (по требованию) -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b0e19; --panel:#121831; --panel2:#18224a; --edge:#263164;
      --text:#e8ebff; --muted:#a7b0d8; --accent:#6c8cff; --accent2:#29d3b1;
      --danger:#ff5c7a; --ok:#35d07f; --warn:#ffcf4a;
      --shadow:0 10px 30px rgba(0,0,0,.4); --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif; color:var(--text);
      background:
        radial-gradient(1200px 600px at 100% 0%, #10163a 0%, transparent 55%),
        radial-gradient(900px 400px at 0% 100%, #0f1942 0%, transparent 55%),
        var(--bg);
    }
    .wrap{max-width:1100px;margin:40px auto;padding:0 16px}
    .header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));box-shadow:var(--shadow)}
    h1{font-size:20px;margin:0;font-weight:700;letter-spacing:.2px}
    .tabs{display:flex;gap:10px;flex-wrap:wrap;border-bottom:1px solid #1e2a5c55;padding-bottom:10px;margin-bottom:18px}
    .tab-btn{appearance:none;border:1px solid #2a3775;padding:10px 14px;border-radius:12px;background:linear-gradient(180deg,#18224a,#121831);color:var(--text);cursor:pointer;font-weight:600;transition:all .15s ease; box-shadow:0 4px 16px rgba(0,0,0,.25) inset}
    .tab-btn:hover{transform:translateY(-1px);border-color:#3752c8}
    .tab-btn.active{background:linear-gradient(180deg,#223070,#1a244f);border-color:#4460ff;color:#fff;box-shadow:0 0 0 2px #4460ff33, var(--shadow)}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,rgba(24,34,74,.9),rgba(18,24,49,.95));border:1px solid #22306a;border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}
    .card h2{margin:0 0 10px 0;font-size:18px}
    .card h3{margin:10px 0 6px 0;font-size:14px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.6px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="text"], input[type="number"], textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #2a3775;outline:none;background:#0e1430;color:var(--text);transition:border .15s ease}
    input:focus, textarea:focus{border-color:#4a67ff}
    .row{display:flex;gap:10px;align-items:center}
    .row>*{flex:1}
    .btn{appearance:none;border:none;cursor:pointer;background:linear-gradient(180deg,#536cff,#3b52d6);color:#fff;padding:12px 16px;border-radius:14px;font-weight:700;letter-spacing:.2px;box-shadow:var(--shadow);transition:transform .05s ease,filter .1s ease}
    .btn:hover{filter:brightness(1.05)} .btn:active{transform:translateY(1px)}
    .btn.secondary{background:linear-gradient(180deg,#1c274d,#151c3b);border:1px solid #2a3775;color:#eaf0ff}
    .btn.small{padding:8px 10px;font-size:12px}
    .list{display:grid;gap:10px}
    .item{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;background:#0d1331;border:1px solid #24306a;border-radius:12px;padding:10px 12px}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid #2a3775;background:#141c43;color:#d6dcff}
    .muted{color:var(--muted)} .notice{margin-top:10px;color:#cfe3ff;font-size:13px}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .danger{color:var(--danger)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Liberation Mono", monospace}
    .spaced{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .small{font-size:12px} .ghost{opacity:.75}
    .table{width:100%;border-collapse:collapse;margin-top:8px}
    .table th,.table td{border-bottom:1px solid #25306a;padding:8px 6px;text-align:left}
    .table th{font-size:12px;color:#aab6ee;text-transform:uppercase;letter-spacing:.6px}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{background:#131a3c;border:1px solid #2a3775;border-radius:999px;padding:6px 10px;font-size:12px}
    canvas{background:#0b112e;border:1px solid #22306a;border-radius:12px}
    .hidden{display:none}
    .conn{display:flex;gap:6px;flex-wrap:wrap}
    .badge{border:1px solid #2a3775;background:#141c43;color:#d6dcff;font-size:12px;border-radius:999px;padding:4px 8px}
    .badge.ok{border-color:#1ea36d;background:#103a2c}
    .badge.err{border-color:#a31e40;background:#3a1020}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Опросник с монетами · GUN.js</h1>
          <div class="small ghost">Три вкладки · P2P синхронизация · Один статический файл</div>
          <div id="conn" class="conn small"></div>
        </div>
      </div>
      <div class="tabs" role="tablist" aria-label="Вкладки">
        <button class="tab-btn active" data-tab="org" aria-selected="true">Организатор</button>
        <button class="tab-btn" data-tab="voter" aria-selected="false">Голосующий</button>
        <button class="tab-btn" data-tab="results" aria-selected="false">Итоги</button>
      </div>
    </div>

    <!-- ORGANIZER -->
    <section id="tab-org" class="grid">
      <div class="card">
        <h2>Создать новый опрос</h2>
        <div class="row">
          <div>
            <label>Текст вопроса</label>
            <input type="text" id="org-question" placeholder="Например: Кого выбрать лидером проекта?" />
          </div>
        </div>

        <h3>Варианты ответа</h3>
        <div id="options" class="tag-inputs"></div>
        <div class="row">
          <button class="btn secondary" id="add-option">+ Добавить вариант</button>
          <button class="btn secondary" id="clear-options">Очистить варианты</button>
        </div>

        <h3>Участники и их монеты</h3>
        <div id="participants" class="tag-inputs"></div>
        <div class="row">
          <button class="btn secondary" id="add-participant">+ Добавить участника</button>
          <button class="btn secondary" id="clear-participants">Очистить участников</button>
        </div>

        <div class="spaced" style="margin-top:16px">
          <button class="btn" id="create-poll">Создать опрос</button>
          <div class="small muted">Коды создаются автоматически</div>
        </div>

        <div id="after-create" class="hidden">
          <h3>Коды доступа для голосующих</h3>
          <table class="table" id="codes-table">
            <thead><tr><th>Участник</th><th>Монет</th><th>Код</th><th></th></tr></thead>
            <tbody></tbody>
          </table>

          <div class="spaced" style="margin-top:14px">
            <div>
              <div class="small muted">Ссылка на опрос (для рассылки голосующим)</div>
              <div class="code mono" id="share-link"></div>
            </div>
            <div class="row" style="max-width:360px">
              <button class="btn secondary" id="copy-share">Скопировать ссылку</button>
              <button class="btn secondary" id="open-voter-link">Открыть как голосующий</button>
            </div>
          </div>

          <div class="notice">Храните коды в секрете: по каждому коду можно проголосовать один раз.</div>
        </div>
      </div>

      <div class="card">
        <h2>Дополнительно</h2>
        <label>Пиры GUN (через запятую). Можно передать и через URL: <span class="mono">?peers=https://a/gun,https://b/gun</span></label>
        <input type="text" id="peer-input" placeholder="https://peer1.example/gun, https://peer2.example/gun" />
        <div class="row" style="margin-top:8px">
          <button class="btn secondary" id="save-peers">Сохранить пиры</button>
          <button class="btn secondary" id="reset-peers">Сбросить к умолчанию</button>
          <button class="btn secondary" id="preset-peers">Добавить пресет</button>
        </div>
        <div class="notice small">Активные пиры: <span id="peers-list" class="mono"></span></div>

        <h3>Открыть существующий опрос</h3>
        <div class="row">
          <input type="text" id="open-existing-id" placeholder="ID опроса (например, abcd123)" />
          <button class="btn secondary" id="open-existing">Открыть</button>
        </div>
        <div id="org-opened-info" class="notice small"></div>
      </div>
    </section>

    <!-- VOTER -->
    <section id="tab-voter" class="grid hidden">
      <div class="card">
        <h2>Вход участника</h2>
        <div class="row">
          <input type="text" id="v-poll" placeholder="ID опроса (например, abcd123)" />
          <input type="text" id="v-code" placeholder="Код доступа (например, J7Q9KZ)" />
          <button class="btn" id="v-connect">Подключиться</button>
        </div>
        <div class="notice small" id="v-status">Готово к подключению.</div>
      </div>

      <div class="card hidden" id="voting-card">
        <div class="spaced">
          <h2 id="v-q">Вопрос</h2>
          <div class="pill">Ваш лимит: <span id="v-limit">0</span> монет</div>
        </div>
        <div class="chips" id="v-legend"></div>
        <div class="notice">Распределите монеты по вариантам. Нельзя превысить лимит. Можно проголосовать меньше лимита.</div>
        <div id="vote-options" class="list" style="margin-top:10px"></div>
        <div class="spaced" style="margin-top:12px">
          <div class="pill">Осталось: <span id="v-left">0</span></div>
          <button class="btn" id="v-submit">Проголосовать</button>
        </div>
        <div id="v-already" class="notice small hidden ok">Ваш голос уже учтён. Спасибо!</div>
      </div>

      <div class="card">
        <h2>Быстрые ссылки</h2>
        <div class="row">
          <button class="btn secondary" id="goto-results">Перейти к итогам</button>
          <button class="btn secondary" id="copy-my-link">Скопировать мою персональную ссылку</button>
        </div>
        <div class="small muted" id="my-link" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- RESULTS -->
    <section id="tab-results" class="grid hidden">
      <div class="card">
        <div class="spaced">
          <h2>Итоги голосования (реальное время)</h2>
          <div class="row" style="max-width:460px">
            <input type="text" id="r-poll" placeholder="ID опроса (например, abcd123)" />
            <button class="btn" id="r-load">Загрузить</button>
          </div>
        </div>
        <div class="notice small">Один и тот же результат виден на всех устройствах при соединении с теми же пирами.</div>

        <div class="row" style="margin-top:12px">
          <div class="pill">Опрос: <span id="r-title" class="mono">—</span></div>
          <div class="pill">Участников проголосовало: <span id="r-voters" class="mono">0</span></div>
        </div>

        <div style="margin-top:14px">
          <canvas id="chart" height="180"></canvas>
        </div>

        <h3>Расклад голосов</h3>
        <table class="table" id="r-table">
          <thead><tr><th>Вариант</th><th>Голоса</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <h2>Поделиться результатами</h2>
        <div class="row">
          <button class="btn secondary" id="r-copy">Скопировать ссылку на итоги</button>
          <button class="btn secondary" id="r-open">Открыть в этом окне</button>
        </div>
        <div class="small muted" id="r-link" style="margin-top:8px"></div>
      </div>
    </section>
  </div>

  <script>
    /**********************
     * УТИЛИТЫ / ПАРАМЕТРЫ
     **********************/
    const dqs = s => document.querySelector(s);
    const dqsa = s => Array.from(document.querySelectorAll(s));
    const $$ = (parent, sel) => Array.from(parent.querySelectorAll(sel));
    const randId = (len=7) => [...crypto.getRandomValues(new Uint8Array(len))]
        .map(n => "abcdefghijklmnopqrstuvwxyz0123456789"[n % 36]).join('');
    const randCode = (len=6) => [...crypto.getRandomValues(new Uint8Array(len))]
        .map(n => "ABCDEFGHJKLMNPQRSTUVWXYZ23456789"[n % 32]).join('');
    const toId = s => (s||'').trim().toLowerCase();

    // Пиры по умолчанию — несколько публичных + совместимые со старыми примерами
    const DEFAULT_PEERS = [
      "https://peer.wallie.io/gun",
      "https://relay.peer.ooo/gun",
      "https://gun-manhattan.herokuapp.com/gun",
      "https://gunjs.herokuapp.com/gun"
    ];

    // Из URL можно передать список пиров
    function peersFromURL(){
      const p = new URLSearchParams(location.search).get('peers');
      if(!p) return null;
      return p.split(',').map(s=>s.trim()).filter(Boolean);
    }

    // Инициализация GUN
    function initGun(){
      const saved = (localStorage.getItem('gun_peers') || '').trim();
      const fromUrl = peersFromURL();
      const peers = (fromUrl && fromUrl.length ? fromUrl :
                    (saved ? saved.split(',').map(s=>s.trim()).filter(Boolean) : DEFAULT_PEERS));
      dqs('#peers-list').textContent = peers.join(', ');
      const g = Gun({ peers, localStorage: true, radisk: true, retry: 1500 });
      wirePeerIndicators(g);
      return g;
    }
    let gun = initGun();
    const DB = gun.get('polls');

    // Индикаторы соединения с пирами (hi/bye)
    function wirePeerIndicators(g){
      const box = dqs('#conn');
      function pill(text, ok=true){
        const s = document.createElement('span'); s.className = 'badge '+(ok?'ok':'err'); s.textContent = text; return s;
      }
      g.on('hi', peer=>{ // новый коннект
        const el = pill('подключено: '+(peer.url||peer.id||'peer'));
        el.dataset.peer = peer.url||peer.id||'peer';
        box.appendChild(el);
      });
      g.on('bye', peer=>{ // отключение
        const id = peer.url||peer.id||'peer';
        box.querySelectorAll(`[data-peer="${CSS.escape(id)}"]`).forEach(e=>e.remove());
        const el = pill('отключено: '+id, false);
        box.appendChild(el); setTimeout(()=>el.remove(), 4000);
      });
    }

    // Табы
    const tabs = { org: dqs('#tab-org'), voter: dqs('#tab-voter'), results: dqs('#tab-results') };
    dqsa('.tab-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        dqsa('.tab-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        Object.values(tabs).forEach(el=>el.classList.add('hidden'));
        const k = btn.dataset.tab;
        tabs[k].classList.remove('hidden');
        if(k==='results'){ setTimeout(()=> chart?.resize?.(), 60); }
      });
    });

    // Настройка пиров
    dqs('#save-peers').addEventListener('click', ()=>{
      const val = dqs('#peer-input').value.trim();
      localStorage.setItem('gun_peers', val);
      gun = initGun();
    });
    dqs('#reset-peers').addEventListener('click', ()=>{
      localStorage.removeItem('gun_peers'); dqs('#peer-input').value = '';
      gun = initGun();
    });
    dqs('#preset-peers').addEventListener('click', ()=>{
      const add = [
        "https://peer.wallie.io/gun",
        "https://relay.peer.ooo/gun",
        "https://gun-manhattan.herokuapp.com/gun",
        "https://gunjs.herokuapp.com/gun"
      ];
      const cur = dqs('#peer-input').value.trim();
      const merged = Array.from(new Set((cur?cur.split(','):[]).concat(add))).map(s=>s.trim()).filter(Boolean);
      dqs('#peer-input').value = merged.join(',');
    });

    /**********************
     * ОРГАНИЗАТОР
     **********************/
    const optionsBox = dqs('#options');
    const participantsBox = dqs('#participants');

    function addOption(value=''){
      const line = document.createElement('div');
      line.className = 'tag-line';
      line.innerHTML = `
        <input type="text" placeholder="Вариант ответа" value="${value.replace(/"/g,'&quot;')}"/>
        <button class="btn small secondary" title="Удалить">Удалить</button>
      `;
      line.querySelector('button').onclick = () => line.remove();
      optionsBox.appendChild(line);
    }
    function addParticipant(name='', votes=''){
      const line = document.createElement('div');
      line.className = 'tag-line';
      line.innerHTML = `
        <div class="row">
          <input type="text" placeholder="Имя участника" value="${name.replace(/"/g,'&quot;')}"/>
          <input type="number" placeholder="Монет" min="0" step="1" value="${votes}"/>
        </div>
        <button class="btn small secondary" title="Удалить">Удалить</button>
      `;
      line.querySelector('button').onclick = () => line.remove();
      participantsBox.appendChild(line);
    }
    dqs('#add-option').onclick = ()=> addOption('');
    dqs('#clear-options').onclick = ()=> optionsBox.innerHTML = '';
    dqs('#add-participant').onclick = ()=> addParticipant('', '');
    dqs('#clear-participants').onclick = ()=> participantsBox.innerHTML = '';

    // Стартовые поля
    ['А','Б','В'].forEach((_,i)=>addOption(`Вариант ${i+1}`));
    ['Анна','Борис','Светлана'].forEach((n)=>addParticipant(n, 10));

    dqs('#create-poll').addEventListener('click', ()=>{
      const question = dqs('#org-question').value.trim();
      const opts = $$(optionsBox,'input[type="text"]').map(i=>i.value.trim()).filter(Boolean);
      const parts = $$(participantsBox,'.row').map(row=>{
        const [nameI, votesI] = $$(row,'input');
        return { name: (nameI.value||'').trim(), votes: parseInt(votesI.value||'0',10) || 0 };
      }).filter(p=>p.name);

      if(!question){ alert('Введите текст вопроса'); return; }
      if(opts.length<1){ alert('Добавьте хотя бы один вариант'); return; }
      if(parts.length<1){ alert('Добавьте хотя бы одного участника'); return; }

      const pollId = toId(randId(7));
      const pollRef = DB.get(pollId);
      const createdAt = Date.now();

      // Пишем мету — ключевое для обнаружения опроса на других устройствах
      pollRef.get('meta').put({ title: question, createdAt, status: 'open' });

      // Варианты
      opts.forEach((t, idx)=>{
        const oid = 'o'+(idx+1);
        pollRef.get('options').get(oid).put({ id: oid, text: t });
      });

      // Участники + коды
      const codes = [];
      parts.forEach(p=>{
        const code = randCode(6);
        codes.push({ ...p, code });
        pollRef.get('participants').get(code).put({ name: p.name, limit: p.votes });
      });

      // UI: коды и шаринг
      dqs('#after-create').classList.remove('hidden');
      const tb = dqs('#codes-table tbody'); tb.innerHTML = '';
      const base = location.origin + location.pathname;
      codes.forEach(c=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHTML(c.name)}</td>
          <td class="mono">${c.votes}</td>
          <td class="mono">${c.code}</td>
          <td><button class="btn secondary small copy-code" data-code="${c.code}" data-poll="${pollId}">Копировать персональную ссылку</button></td>`;
        tb.appendChild(tr);
      });
      const share = `${base}?poll=${pollId}`;
      dqs('#share-link').textContent = share;
      dqs('#copy-share').onclick = ()=> copyText(share, 'Ссылка скопирована');
      dqs('#open-voter-link').onclick = ()=> (location.href = share + '#voter');

      tb.addEventListener('click', (e)=>{
        const btn = e.target.closest('.copy-code'); if(!btn) return;
        const code = btn.dataset.code, pid = btn.dataset.poll;
        const link = `${base}?poll=${pid}&code=${code}#voter`;
        copyText(link, 'Персональная ссылка скопирована');
      });

      dqs('#org-opened-info').innerHTML = `Опрос создан. ID: <b class="mono">${pollId}</b>.`;
      localStorage.setItem('last_poll', pollId);
    });

    dqs('#open-existing').addEventListener('click', ()=>{
      const pid = toId(dqs('#open-existing-id').value);
      if(!pid){ alert('Введите ID опроса'); return; }
      DB.get(pid).get('meta').once(meta=>{
        if(!meta){ alert('Опрос не найден'); return; }
        dqs('#org-opened-info').innerHTML = `Открыт опрос <b class="mono">${pid}</b>: «${escapeHTML(meta.title||'') }»`;
      });
    });

    /**********************
     * ГОЛОСУЮЩИЙ
     **********************/
    let voterState = { pollId:null, code:null, limit:0, options:[], allocations:{}, submitted:false, title:'' };

    dqs('#v-connect').addEventListener('click', connectAsVoter);
    dqs('#v-submit').addEventListener('click', submitVote);
    dqs('#goto-results').addEventListener('click', ()=>{
      const pid = voterState.pollId || toId(dqs('#v-poll').value);
      if(!pid){ alert('Сначала подключитесь к опросу'); return; }
      openTab('results'); dqs('#r-poll').value = pid; loadResults(pid);
    });
    dqs('#copy-my-link').addEventListener('click', ()=>{
      const pid = voterState.pollId || toId(dqs('#v-poll').value);
      const code = voterState.code || dqs('#v-code').value.trim().toUpperCase();
      if(!pid || !code){ alert('Сначала подключитесь'); return; }
      const base = location.origin + location.pathname;
      const link = `${base}?poll=${pid}&code=${code}#voter`;
      copyText(link, 'Персональная ссылка скопирована'); dqs('#my-link').textContent = link;
    });

    async function connectAsVoter(){
      const pollId = toId(dqs('#v-poll').value);
      const code = dqs('#v-code').value.trim().toUpperCase();
      if(!pollId || !code){ setVStatus('Укажите ID опроса и код', true); return; }
      setVStatus('Подключаемся к пирам и ищем опрос…');

      const pollRef = DB.get(pollId);

      // 1) Ждём мету опроса с подпиской и запасом времени
      const meta = await waitForMeta(pollRef, 9000);
      if(!meta){
        setVStatus('Опрос пока не найден. Проверьте ID и пиры. Мы продолжаем пытаться…', true);
        // продолжаем слушать — если мета приедет позже, UI обновится
      } else {
        voterState.title = meta.title || 'Опрос';
        dqs('#v-q').textContent = voterState.title;
      }

      // 2) Проверяем код/лимит (тоже ждём с подпиской)
      const limit = await waitForLimit(pollRef, code, 9000);
      if(limit == null){
        setVStatus('Код не найден на текущих пирах. Убедитесь, что подключены те же пиры, или попробуйте ещё раз.', true);
        // не выходим: если лимит появится — продолжим
      } else {
        voterState.limit = parseInt(limit||0,10)||0;
        voterState.pollId = pollId; voterState.code = code;
        dqs('#v-limit').textContent = voterState.limit;
        dqs('#v-left').textContent = voterState.limit;
        setVStatus(`Код принят. Лимит: <b class="mono">${voterState.limit}</b>`);
        localStorage.setItem('v_last', JSON.stringify({pollId, code}));
      }

      // 3) Флаг submitted
      pollRef.get('submissions').get(code).get('submitted').on(flag=>{
        voterState.submitted = !!flag;
        dqs('#v-already').classList.toggle('hidden', !voterState.submitted);
      });

      // 4) Варианты — подписка
      voterState.options = [];
      pollRef.get('options').map().on((o, k)=>{
        if(!o || !o.text) return;
        const id = o.id || k;
        const exist = voterState.options.find(x=>x.id===id);
        if(!exist){ voterState.options.push({id, text:o.text}); schedule(renderVotingUI); }
      });

      dqs('#voting-card').classList.remove('hidden');
    }

    // Ожидание метаданных (надёжное «обнаружение» опроса)
    function waitForMeta(pollRef, timeoutMs=8000){
      return new Promise(resolve=>{
        let done=false; const t = setTimeout(()=>{ if(!done){ done=true; resolve(null);} }, timeoutMs);
        pollRef.get('meta').on(meta=>{
          if(done) return;
          if(meta){ done=true; clearTimeout(t); resolve(meta); }
        });
      });
    }
    // Ожидание участника/лимита по коду
    function waitForLimit(pollRef, code, timeoutMs=8000){
      return new Promise(resolve=>{
        let done=false; const t = setTimeout(()=>{ if(!done){ done=true; resolve(null);} }, timeoutMs);
        pollRef.get('participants').get(code).on(p=>{
          if(done) return;
          if(p && (p.limit!=null)){ done=true; clearTimeout(t); resolve(p.limit); }
        });
      });
    }

    function renderVotingUI(){
      voterState.options.sort((a,b)=> (a.id>b.id?1:-1));
      const box = dqs('#vote-options'); box.innerHTML='';
      const legend = dqs('#v-legend'); legend.innerHTML = '';
      voterState.allocations = {};

      voterState.options.forEach(opt=>{
        voterState.allocations[opt.id] = 0;
        const line = document.createElement('div');
        line.className = 'item';
        line.innerHTML = `
          <div>
            <div><b>${escapeHTML(opt.text)}</b></div>
            <div class="small muted">ID: <span class="mono">${opt.id}</span></div>
          </div>
          <div class="row" style="max-width:280px">
            <button class="btn small secondary" data-act="dec">−</button>
            <input type="number" min="0" step="1" value="0" class="mono vote-num" data-id="${opt.id}" />
            <button class="btn small secondary" data-act="inc">+</button>
          </div>`;
        const input = line.querySelector('.vote-num');
        const dec = line.querySelector('[data-act="dec"]');
        const inc = line.querySelector('[data-act="inc"]');

        function apply(val){
          val = clamp(0, voterState.limit, parseInt(val||0,10)||0);
          const totalOther = totalAllocatedExcept(opt.id);
          if(totalOther + val > voterState.limit) val = Math.max(0, voterState.limit - totalOther);
          voterState.allocations[opt.id] = val; input.value = val; updateLeft();
        }
        input.addEventListener('input', ()=> apply(input.value));
        dec.addEventListener('click', ()=> apply((+input.value||0)-1));
        inc.addEventListener('click', ()=> apply((+input.value||0)+1));

        box.appendChild(line);
        const chip = document.createElement('div'); chip.className='chip'; chip.textContent = opt.text; legend.appendChild(chip);
      });

      updateLeft();
    }

    function totalAllocated(){ return Object.values(voterState.allocations).reduce((a,b)=>a+(parseInt(b||0,10)||0),0); }
    function totalAllocatedExcept(id){
      return Object.entries(voterState.allocations).filter(([k])=>k!==id)
        .reduce((a,[,v])=>a+(parseInt(v||0,10)||0),0);
    }
    function updateLeft(){
      dqs('#v-left').textContent = Math.max(0, voterState.limit - totalAllocated());
    }

    // Запись голоса: КАЖДЫЙ вариант — отдельный узел; submitted — отдельно (устойчивый CRDT)
    function submitVote(){
      if(voterState.submitted){ alert('Ваш голос уже учтён'); return; }
      const sum = totalAllocated();
      if(sum === 0 && !confirm('Вы не распределили ни одной монеты. Отправить пустой голос?')) return;

      const pollRef = DB.get(voterState.pollId);
      const subRef  = pollRef.get('submissions').get(voterState.code);

      Object.entries(voterState.allocations).forEach(([optId, val])=>{
        subRef.get('votes').get(optId).put(parseInt(val||0,10) || 0);
      });
      subRef.get('submitted').put(true);
      subRef.get('submittedAt').put(Date.now());

      voterState.submitted = true;
      dqs('#v-already').classList.remove('hidden');
      alert('Голос учтён! Спасибо.');
    }

    function setVStatus(msg, isErr=false){
      dqs('#v-status').innerHTML = isErr ? `<span class="danger">${msg}</span>` : msg;
    }

    /**********************
     * ИТОГИ
     **********************/
    let chart = null, ChartLibLoaded = false;
    const chartCtx = document.getElementById('chart').getContext('2d');
    let resultWatch = { pollId: null, offFns: [] };

    dqs('#r-load').addEventListener('click', ()=>{
      const pid = toId(dqs('#r-poll').value);
      if(!pid){ alert('Введите ID опроса'); return; }
      loadResults(pid);
    });

    async function loadResults(pollId){
      // Снятие старых подписок
      resultWatch.offFns.forEach(fn=>fn && fn()); resultWatch = { pollId, offFns: [] };

      const pollRef = DB.get(pollId);
      pollRef.get('meta').on(meta=>{ dqs('#r-title').textContent = meta?.title || '—'; });

      // Состояние
      const state = { options:{}, submissions:{}, submittedFlag:{} };

      // Опции
      const optMap = pollRef.get('options');
      optMap.map().on((o, k)=>{
        if(!o) return;
        const id = o.id || k; state.options[id] = o.text || id; schedule(()=> recompute(state));
      });
      resultWatch.offFns.push(()=> optMap.map().off());

      // Анкеты
      const subsMap = pollRef.get('submissions');
      subsMap.map().on((sub, code)=>{
        if(!code) return;
        state.submittedFlag[code] = !!(sub && sub.submitted);
        const votesRef = subsMap.get(code).get('votes');
        votesRef.map().on((val, optId)=>{
          if(!state.submissions[code]) state.submissions[code] = {};
          state.submissions[code][optId] = parseInt(val||0,10)||0;
          schedule(()=> recompute(state));
        });
        resultWatch.offFns.push(()=> votesRef.map().off());
      });
      resultWatch.offFns.push(()=> subsMap.map().off());

      // Линки
      const base = location.origin + location.pathname;
      const link = `${base}?poll=${pollId}#results`;
      dqs('#r-link').textContent = link;
      dqs('#r-copy').onclick = ()=> copyText(link, 'Ссылка на результаты скопирована');
      dqs('#r-open').onclick = ()=> (location.href = link);

      // Ленивая загрузка Chart.js
      if(!ChartLibLoaded){
        await loadScript('https://cdn.jsdelivr.net/npm/chart.js');
        ChartLibLoaded = true;
      }
    }

    function recompute(state){
      const ids = Object.keys(state.options).sort();
      const labels = ids.map(id => state.options[id]);
      const totals = Object.fromEntries(ids.map(id=>[id, 0]));
      let votedCount = 0;

      Object.entries(state.submissions).forEach(([code, vmap])=>{
        const anyVotes = vmap && Object.values(vmap).some(v => (parseInt(v||0,10)||0) > 0);
        const counted = state.submittedFlag[code] || anyVotes;
        if(counted) votedCount++;
        ids.forEach(id=> totals[id] += parseInt((vmap && vmap[id]) || 0, 10) || 0);
      });

      // Таблица
      const tbody = dqs('#r-table tbody'); tbody.innerHTML = '';
      ids.forEach(id=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHTML(state.options[id])}</td><td class="mono">${totals[id]}</td>`;
        tbody.appendChild(tr);
      });
      dqs('#r-voters').textContent = votedCount;

      // Диаграмма
      const data = ids.map(id => totals[id]);
      if(!chart){
        chart = new Chart(chartCtx, {
          type: 'bar',
          data: { labels, datasets: [{ label: 'Голоса', data }] },
          options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { precision:0 } } } }
        });
      } else {
        chart.data.labels = labels; chart.data.datasets[0].data = data; chart.update('none');
      }
    }

    /**********************
     * ОБЩЕЕ / ХЕЛПЕРЫ
     **********************/
    function openTab(key){
      dqsa('.tab-btn').forEach(b=>{
        b.classList.toggle('active', b.dataset.tab===key);
        b.setAttribute('aria-selected', b.dataset.tab===key ? 'true' : 'false');
      });
      Object.entries(tabs).forEach(([k,el])=> el.classList.toggle('hidden', k!==key));
    }

    function copyText(text, toast='Скопировано'){
      navigator.clipboard.writeText(text).catch(()=>{
        const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select();
        try{ document.execCommand('copy'); } catch {}
        ta.remove();
      });
    }

    function escapeHTML(s){ return (s||'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }
    const clamp = (min,max,x)=> Math.max(min, Math.min(max, x));

    // schedule: объединяем частые перерисовки в один кадр
    let rafId=null, queue=[];
    function schedule(fn){
      queue.push(fn);
      if(rafId) return;
      rafId = requestAnimationFrame(()=>{
        const q = queue; queue=[]; rafId=null;
        for(const f of q) try{ f(); }catch(e){ console.error(e); }
      });
    }

    function loadScript(src){
      return new Promise((resolve,reject)=>{
        const s = document.createElement('script'); s.src = src; s.onload=resolve; s.onerror=reject; document.head.appendChild(s);
      });
    }

    // Bootstrap из URL
    (function bootstrapFromURL(){
      const params = new URLSearchParams(location.search);
      const poll = toId(params.get('poll'));
      const code = (params.get('code')||'').trim().toUpperCase();
      const hash = location.hash.replace('#','');

      if(poll){
        dqs('#v-poll').value = poll; dqs('#r-poll').value = poll; dqs('#open-existing-id').value = poll;
        dqs('#share-link').textContent = (location.origin + location.pathname + '?poll=' + poll);
        dqs('#after-create').classList.add('hidden');
      }
      if(code){ dqs('#v-code').value = code; }

      if(hash==='voter'){ openTab('voter'); }
      if(hash==='results'){ openTab('results'); if(poll) loadResults(poll); }

      const quick = params.get('autoconnect');
      if(poll && code && (hash==='voter' || quick==='1')) setTimeout(()=> connectAsVoter(), 200);

      // Подхват предыдущего логина
      if(!poll || !code){
        try{
          const vlast = JSON.parse(localStorage.getItem('v_last')||'{}');
          if(vlast.pollId && !poll) dqs('#v-poll').value = vlast.pollId;
          if(vlast.code && !code) dqs('#v-code').value = vlast.code;
        }catch{}
      }
    })();

    // Подсказка организатору
    (function greetOrg(){
      const last = localStorage.getItem('last_poll');
      if(last) dqs('#org-opened-info').innerHTML = `Последний созданный опрос: <b class="mono">${last}</b>`;
    })();
  </script>
</body>
</html>
