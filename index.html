<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Опросник с GUN.js</title>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9fb; }
    h2 { color: #333; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .tab { padding: 10px 20px; border-radius: 8px; background: #eee; cursor: pointer; }
    .tab.active { background: #4a90e2; color: white; }
    .content { display: none; }
    .content.active { display: block; }
    input, button, textarea { padding: 8px; margin: 5px 0; border-radius: 6px; border: 1px solid #ccc; width: 100%; }
    button { background: #4a90e2; color: white; border: none; cursor: pointer; }
    button:hover { background: #357ab8; }
    .option, .participant { display: flex; gap: 10px; margin-bottom: 5px; }
    .results { margin-top: 15px; background: #fff; padding: 10px; border-radius: 8px; }
  </style>
</head>
<body>

  <div class="tabs">
    <div class="tab active" data-tab="organizer">Организатор</div>
    <div class="tab" data-tab="voter">Голосование</div>
    <div class="tab" data-tab="results">Итоги</div>
  </div>

  <!-- Организатор -->
  <div id="organizer" class="content active">
    <h2>Создание опроса</h2>
    <label>Вопрос:</label>
    <input type="text" id="question">

    <h3>Варианты ответа</h3>
    <div id="options"></div>
    <button onclick="addOption()">+ Добавить вариант</button>

    <h3>Участники</h3>
    <div id="participants"></div>
    <button onclick="addParticipant()">+ Добавить участника</button>

    <button onclick="createPoll()">Создать опрос</button>
    <div id="pollLink"></div>
  </div>

  <!-- Голосование -->
  <div id="voter" class="content">
    <h2>Голосование</h2>
    <input type="text" id="accessCode" placeholder="Введите код доступа">
    <button onclick="enterPoll()">Войти</button>
    <div id="votingArea" style="display:none;">
      <h3 id="pollQuestion"></h3>
      <div id="voteOptions"></div>
      <button onclick="submitVote()">Проголосовать</button>
    </div>
  </div>

  <!-- Итоги -->
  <div id="results" class="content">
    <h2>Итоги голосования</h2>
    <div id="resultsArea"></div>
  </div>

  <script>
    const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
    const urlParams = new URLSearchParams(window.location.search);
    const pollId = urlParams.get("poll");

    let currentPoll = null;
    let myCode = null;

    // Переключение вкладок
    document.querySelectorAll(".tab").forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".content").forEach(c => c.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(tab.dataset.tab).classList.add("active");
      };
    });

    // Добавление вариантов
    function addOption() {
      const div = document.createElement("div");
      div.className = "option";
      div.innerHTML = `<input type="text" placeholder="Вариант ответа">`;
      document.getElementById("options").appendChild(div);
    }

    // Добавление участников
    function addParticipant() {
      const div = document.createElement("div");
      div.className = "participant";
      div.innerHTML = `<input type="text" placeholder="Имя"> <input type="number" placeholder="Голоса">`;
      document.getElementById("participants").appendChild(div);
    }

    // Создание опроса
    function createPoll() {
      const question = document.getElementById("question").value;
      const options = [...document.querySelectorAll("#options input")].map(o => o.value).filter(v => v);
      const participants = [...document.querySelectorAll("#participants .participant")].map(p => {
        const [name, votes] = p.querySelectorAll("input");
        return { name: name.value, votes: +votes.value, code: Math.random().toString(36).substring(2, 8) };
      });

      const newPollId = Math.random().toString(36).substring(2, 10);
      gun.get("polls").get(newPollId).put({ question, options, participants });

      let codes = participants.map(p => `${p.name}: ${p.code} (${p.votes} голосов)`).join("<br>");
      document.getElementById("pollLink").innerHTML = `
        <p>Ссылка на опрос: <a href="?poll=${newPollId}">${window.location.origin}${window.location.pathname}?poll=${newPollId}</a></p>
        <p><b>Коды доступа:</b><br>${codes}</p>`;
    }

    // Вход голосующего
    function enterPoll() {
      if (!pollId) {
        alert("Нет параметра poll в URL!");
        return;
      }
      const code = document.getElementById("accessCode").value.trim();
      myCode = code;

      gun.get("polls").get(pollId).once(poll => {
        if (!poll) { alert("Опрос не найден"); return; }
        currentPoll = poll;
        const participant = poll.participants.find(p => p.code === code);
        if (!participant) { alert("Неверный код"); return; }

        document.getElementById("votingArea").style.display = "block";
        document.getElementById("pollQuestion").innerText = poll.question;

        const voteOptions = document.getElementById("voteOptions");
        voteOptions.innerHTML = "";
        poll.options.forEach(opt => {
          voteOptions.innerHTML += `<label>${opt}: <input type="number" min="0" max="${participant.votes}" data-option="${opt}" value="0"></label><br>`;
        });
      });
    }

    // Отправка голоса
    function submitVote() {
      const inputs = [...document.querySelectorAll("#voteOptions input")];
      const votes = inputs.map(i => ({ option: i.dataset.option, value: +i.value }));

      gun.get("polls").get(pollId).get("votes").get(myCode).put(JSON.stringify(votes));
      alert("Ваш голос учтен!");
    }

    // Итоги
    if (pollId) {
      gun.get("polls").get(pollId).on(poll => {
        if (!poll || !poll.options) return;
        let results = {};
        poll.options.forEach(opt => results[opt] = 0);

        if (poll.votes) {
          Object.values(poll.votes).forEach(v => {
            if (v) {
              JSON.parse(v).forEach(({ option, value }) => {
                results[option] += value;
              });
            }
          });
        }

        document.getElementById("resultsArea").innerHTML = Object.entries(results)
          .map(([opt, val]) => `<p>${opt}: ${val}</p>`).join("");
      });
    }
  </script>
</body>
</html>
